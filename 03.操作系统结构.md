# 操作系统结构

## 1.复杂系统

1. 结构的重要性

​	不同的需求对于一个系统的结构要求可能是相互冲突的，如果片面的追求满足所有需求，很可能会导致系统的现实性物理支撑被削弱，导致系统结构的稳定性降低。所以我们应当追求的是不同需求以及系统结构基于现实稳定性的博弈性平衡。

> 瓦萨沉船、苏联的 N1 与美国的土星五号火箭、Workplace操作系统
>
> ——复杂系统的构建必须考虑其内部结构
>
> ​		• 不同目标之间往往存在冲突
>
> ​		• 不同需求之间需要进行权衡

2. 设计思想

* 策略与机制的分离

     策略就是你建造这个东西是要做什么；机制就是如何去实现。

| 例子 | 策略                                               | 机制                                               |
| :--- | -------------------------------------------------- | :------------------------------------------------- |
| 登录 | 什么用户、以什么权限登录                           | 输入处理、策略文件管理、桌面启动加载 ...           |
| 调度 | 调度算法：Round-robin、Earliest Deadline First ... | 调度队列、调度实体（如线程的表示、调度中断处理 ... |

* **M.A.L.H.** **原则**

  * **模块化 (Modularity)**：类似于分治法，要求各模块之间达到高内聚和低耦合的。
  * **抽象 (Abstract)**：是模块化的必然要求，包括接口和内部实现。

  ​       封装完的模块建立好之后，我们就可以根据系统的需求，利用各个模块所提供的服务，构建整体的系统。但是对于一个复杂系统，其模块可能会十分多、模块间的需求关系可能也会十分复杂，所以为了进一步提高效率，增强系统整体的结构性，在前两者的基础上，又提出了**分层(Layering)**与**层级(Hierarchy)**两种原则：

  分层结构强调层内的完整性
  
  ![分层结构](图片\4.3.PNG)
  
  层级结构表征天然的包含关系
  
  ![层级结构](图片\4.4.PNG)
  
  
  
  

## 2.多种内核结构

1. 简要结构

   没有用户态与内核态的特权级分割，也没有内存管理，整个就是一个大程序。

   优点：快；      缺点：容易直接整个系统崩溃。

   例如：MS-DOS

![](图片\4.1.PNG)

2. **宏内核(Monolithic Kernel)**

   将整个系统分为**内核**和**应用**两层：内核运行在特权级，集中控制所有计算资源，并且向应用级提供系统调用；应用运行在非特权级，受内核管理，使用内核服务。

   ![](图片\4.5.PNG)

   优点：拥有丰富的沉淀与积累，生态相对比较完善(如Linux)

   缺点：

   * **安全性和可靠性问题**：内核中模块之间没有很强的隔离机制，容易产生安全性问题。
   * **实时性支持**：系统细化不够具体，内核系统太过复杂导致无法做最坏情况时延分析。
   * **系统过于庞大而阻碍了创新**：Linux代码行数已经过2千万。

   >为什么内核的内部不能再进行细分了，既然能够设置用户态和内核态之间的特权级划分，为什么不能直接在内核内部进行细化？

   以上缺点导致宏内核难以满足的场景：

   * 向上向下的扩展：很难去剪裁/扩展一个宏内核系统支持从KB级别到TB级别的场景

   *  硬件异构性：很难长期支持一些定制化的方式去解决一些特定问题

   * 功能安全：一个广泛共识：Linux无法通过汽车安全完整性认证（ASIL-D） 

   * 信息安全：单点错误会导致整个系统出错，而现在有数百个安全问题（CVE） 

   * 确定性时延：Linux花费10+年合并实时补丁，目前依然不确定是否能支持确定性时延

3. **微内核(Micro-kernel)**

   设计原则：最小化内核功能（把所有可能和操作系统核心功能无关的功能全部剥离出去，所谓的核心功能没有具体的定义，微内核追求最小化的内核功能）。将某些操作系统功能(尤其是某些可能产生安全性隐患的)移到用户态，称为"服务"。 

   在用户模块(进程)之间，使用消息传递机制通信（进程间通信：Inter-Process Communication, IPC）：经过内核态进行通信，从而产生隔离的效果。但是IPC时非常缓慢的，这也是微内核目前面对的主要问题之一。

   ![](图片\4.6.PNG)

   例：文件的创建
   
   ![](图片\4.2.PNG)

​		PS：微内核操作系统中个进程之间的相互通信一定是要经过内核的——可以增强安全性。

* **微内核的优缺点分析：**

  > * 优点：
  >
  >   * 易于扩展：直接添加一个用户进程即可为操作系统增加服务（内核和操作系统又有什么区别？）
  >   *  易于移植：大部分模块与底层硬件无关
  >   * 更加可靠：在内核模式运行的代码量大大减少
  >   * 更加安全：即使存在漏洞，服务与服务之间存在进程粒度隔离
  >   * 更加健壮：单个模块出现问题不会影响到系统整体
  >
  >   缺点：
  >
  >   * **性能较差：内核中的模块交互由函数调用变成了进程间通信**
  >   * 生态欠缺：尚未形成像Linux一样具有广泛开发者的社区
  >   * 重用问题：重用宏内核操作系统提供兼容性，带来新问题

4. 混合内核架构

	就是所谓的宏内核与微内核的思想相结合：把一些不太重要的功能、安全性要求比较高的进程放在用户态，对性能要求比较高的功能放在内核态。





